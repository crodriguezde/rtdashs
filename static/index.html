<html>
  <head>
    <meta charset="utc-8" />
    <title>Synthetics realtime dashboards</title>
    <script src="//cdn.plot.ly/plotly-2.18.0.min.js"></script>
  </head>
  <body>
    <h1>Synthetics metrics latency</h1>
    <script>
      // Fire up a new event source connected to the server
      var sse = new EventSource("/api/stream/cpu");
      var iDiv = document.createElement("div");
      document.body.appendChild(iDiv);

      var graphs = {};

      function createGauge(metric) {
        var data = [
          {
            type: "indicator",
            mode: "gauge+number+delta",
            value: metric.latency,
            // delta: {reference: 400, increasing: {color: "RebeccaPurple" } },
            gauge: {
              shape: "bullet",
              axis: {
                range: [null, 20000],
                tickwidth: 1,
                tickcolor: "darkblue",
              },
              bar: { color: "darkblue" },
              bgcolor: "white",
              borderwidth: 2,
              bordercolor: "gray",
              steps: [
                { range: [0, 10000], color: "cyan" },
                { range: [10000, 15000], color: "royalblue" },
              ],
              threshold: {
                line: { color: "red", width: 4 },
                thickness: 0.75,
                value: 18500,
              },
            },
          },
        ];
        // Create new plotty chart
        var layout = {
          width: 1024,
          height: 100,
          margin: { t: 25, r: 25, l: 25, b: 25 },
          paper_bgcolor: "lavender",
          font: { color: "darkblue", family: "Arial" },
          title: {
            text: "Metric latency for " + metric.host,
            font: { size: 16 },
          },
        };

        Plotly.newPlot(metric.host, data, layout);
      }

      sse.addEventListener("update", function (e) {
        // Parse the JSON
        var metric = JSON.parse(e.data);

        if (metric.cpu === "cpu-total") {
          //console.log("DEBUG: latency " + metric.latency);
          // if new graph
          if (!(metric.host in graphs)) {
            //console.log("Creating new graph for " + data.host)
            // Update dictionary
            graphs[metric.host] = new Array();

            //console.log("Creating div for " + data["host"] )
            // Create div
            var graphDiv = document.createElement("div");
            graphDiv.setAttribute("id", metric.host);
            iDiv.appendChild(graphDiv);

            createGauge(metric);
            graphs[metric.host].push(metric.cpu);
          } else {
            var update = {
              value: metric.latency,
            };
            Plotly.update(metric.host, update, {}, [0]);
          }
        }
      });
    </script>
  </body>
</html>
